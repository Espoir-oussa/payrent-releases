<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a237e">
    <meta name="description" content="PayRent - Application de gestion locative simplifi√©e">
    
    <title>PayRent - Gestion Locative</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #3949ab;
            --primary-dark: #0d1642;
            --accent: #ff6b35;
            --success: #43a047;
            --danger: #e53935;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-500: #6c757d;
            --gray-800: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        
        .bg-animation span {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            animation: float 25s linear infinite;
            bottom: -150px;
            border-radius: 50%;
        }
        
        .bg-animation span:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .bg-animation span:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .bg-animation span:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .bg-animation span:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .bg-animation span:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .bg-animation span:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .bg-animation span:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .bg-animation span:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .bg-animation span:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .bg-animation span:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }
        
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; }
        }
        
        /* Main container */
        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        /* Card */
        .card {
            background: var(--white);
            border-radius: 24px;
            padding: 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Logo */
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.3);
        }
        
        .logo span {
            font-size: 50px;
        }
        
        .app-name {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .app-tagline {
            color: var(--gray-500);
            font-size: 14px;
            font-weight: 400;
        }
        
        /* Version badge */
        .version-badge {
            display: inline-block;
            background: var(--gray-100);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        /* Invitation message */
        .invitation-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--success);
        }
        
        .invitation-box.reject {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left-color: var(--danger);
        }
        
        .invitation-box h3 {
            color: var(--success);
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .invitation-box.reject h3 {
            color: var(--danger);
        }
        
        .invitation-box p {
            color: var(--gray-800);
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Loading state */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 35, 126, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay p {
            color: var(--white);
            font-size: 16px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 16px 24px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
            color: var(--white);
            box-shadow: 0 8px 25px rgba(67, 160, 71, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(67, 160, 71, 0.5);
        }
        
        .btn-app {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            box-shadow: 0 8px 25px rgba(26, 35, 126, 0.4);
        }
        
        .btn-app:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(26, 35, 126, 0.5);
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-800);
            border: 2px solid var(--gray-200);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #ef5350 100%);
            color: var(--white);
        }
        
        .btn-icon {
            font-size: 24px;
        }
        
        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: var(--gray-500);
            font-size: 13px;
        }
        
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }
        
        .divider span {
            padding: 0 15px;
        }
        
        /* Download section */
        .download-section {
            text-align: center;
        }
        
        .download-section h3 {
            color: var(--gray-800);
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .download-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .download-card {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 20px 15px;
            text-decoration: none;
            color: var(--gray-800);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .download-card:hover {
            background: var(--white);
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .download-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .download-card.disabled:hover {
            transform: none;
            border-color: transparent;
            box-shadow: none;
        }
        
        .download-card .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .download-card .platform {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .download-card .info {
            font-size: 11px;
            color: var(--gray-500);
        }
        
        /* Features */
        .features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid var(--gray-200);
        }
        
        .feature {
            text-align: center;
        }
        
        .feature .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .feature .text {
            font-size: 11px;
            color: var(--gray-500);
            line-height: 1.4;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }
        
        .footer a {
            color: var(--white);
            text-decoration: none;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .card {
                padding: 30px 20px;
                border-radius: 20px;
            }
            
            .logo {
                width: 80px;
                height: 80px;
            }
            
            .logo span {
                font-size: 40px;
            }
            
            .app-name {
                font-size: 26px;
            }
            
            .download-grid {
                grid-template-columns: 1fr;
            }
            
            .features {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Animated background -->
    <div class="bg-animation">
        <span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span>
    </div>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>Ouverture de PayRent...</p>
    </div>
    
    <!-- Main container -->
    <div class="container">
        <div class="card">
            <!-- Logo -->
            <div class="logo-container">
                <div class="logo">
                    <span>üè†</span>
                </div>
                <h1 class="app-name">PayRent</h1>
                <p class="app-tagline">Gestion locative simplifi√©e</p>
                <span class="version-badge" id="version-badge">Chargement...</span>
            </div>
            
            <!-- Invitation message (shown only if token present) -->
            <div class="invitation-box" id="invitation-box">
                <h3>
                    <span>üìß</span>
                    <span id="invitation-title">Vous avez une invitation !</span>
                </h3>
                <p id="invitation-text">
                    Vous avez √©t√© invit√© √† rejoindre un logement sur PayRent. 
                    Ouvrez l'application pour accepter l'invitation.
                </p>
            </div>
            
            <!-- Action button (if has token) -->
            <div id="action-buttons">
                <a href="#" class="btn btn-app" id="open-app-btn" onclick="openApp(); return false;">
                    <span class="btn-icon">üì±</span>
                    <span>Ouvrir dans PayRent</span>
                </a>
            </div>
            
            <div class="divider"><span>ou t√©l√©chargez l'application</span></div>
            
            <!-- Download section -->
            <div class="download-section">
                <h3>üì• T√©l√©charger PayRent</h3>
                
                <div class="download-grid">
                    <a href="#" class="download-card" id="android-download" onclick="downloadAndroid(); return false;">
                        <div class="icon">ü§ñ</div>
                        <div class="platform">Android</div>
                        <div class="info" id="android-version">Chargement...</div>
                    </a>
                    
                    <div class="download-card disabled" id="ios-download">
                        <div class="icon">üçé</div>
                        <div class="platform">iOS</div>
                        <div class="info">Bient√¥t disponible</div>
                    </div>
                </div>
            </div>
            
            <!-- Features -->
            <div class="features">
                <div class="feature">
                    <div class="icon">üí∞</div>
                    <div class="text">Gestion des loyers</div>
                </div>
                <div class="feature">
                    <div class="icon">üìä</div>
                    <div class="text">Suivi des paiements</div>
                </div>
                <div class="feature">
                    <div class="icon">üí¨</div>
                    <div class="text">Communication facile</div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>¬© 2024 PayRent - Tous droits r√©serv√©s</p>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION - √Ä MODIFIER SELON VOS BESOINS
        // ============================================
        const CONFIG = {
            // URL du fichier JSON contenant les infos de version
            // H√©berg√© sur GitHub dans le m√™me repo que cette page
            versionUrl: './version.json',
            
            // Deep link scheme de l'app
            appScheme: 'payrent',
            
            // Fallback version si le fetch √©choue
            fallbackVersion: '1.0.0'
        };
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let appVersion = CONFIG.fallbackVersion;
        let apkUrl = '';
        let apkSize = '';
        
        // ============================================
        // R√âCUP√âRATION DES PARAM√àTRES URL
        // ============================================
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const action = urlParams.get('action') || 'accept';
        
        // ============================================
        // CONSTRUCTION DU DEEP LINK
        // ============================================
        function buildDeepLink() {
            if (token) {
                return `${CONFIG.appScheme}://accept-invitation?token=${token}&action=${action}`;
            }
            return `${CONFIG.appScheme}://`;
        }
        
        // ============================================
        // MISE √Ä JOUR DE L'UI SELON LE CONTEXTE
        // ============================================
        function updateUI() {
            const invitationBox = document.getElementById('invitation-box');
            const invitationTitle = document.getElementById('invitation-title');
            const invitationText = document.getElementById('invitation-text');
            const actionButtons = document.getElementById('action-buttons');
            
            if (!token) {
                // Pas de token = page de t√©l√©chargement simple
                invitationBox.classList.add('hidden');
                actionButtons.innerHTML = `
                    <a href="#" class="btn btn-app" onclick="openApp(); return false;">
                        <span class="btn-icon">üì±</span>
                        <span>Ouvrir PayRent</span>
                    </a>
                `;
            } else if (action === 'reject') {
                // Action de refus
                invitationBox.classList.add('reject');
                invitationTitle.textContent = 'Refuser l\'invitation';
                invitationText.textContent = 'Vous √™tes sur le point de refuser une invitation. Ouvrez l\'application pour confirmer.';
            }
        }
        
        // ============================================
        // R√âCUP√âRATION DE LA VERSION DEPUIS LE FICHIER JSON
        // ============================================
        async function fetchVersion() {
            try {
                // Ajouter un timestamp pour √©viter le cache
                const response = await fetch(CONFIG.versionUrl + '?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    appVersion = data.version || CONFIG.fallbackVersion;
                    apkUrl = data.apkUrl || '';
                    apkSize = data.size || '';
                    
                    // Mettre √† jour l'affichage
                    document.getElementById('version-badge').textContent = `v${appVersion}`;
                    
                    let androidInfo = `v${appVersion}`;
                    if (apkSize) {
                        androidInfo += ` ‚Ä¢ ${apkSize}`;
                    }
                    document.getElementById('android-version').textContent = androidInfo;
                    
                    if (apkUrl) {
                        document.getElementById('android-download').href = apkUrl;
                    }
                    
                    console.log('‚úÖ Version charg√©e:', appVersion);
                } else {
                    throw new Error('R√©ponse non OK');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Impossible de r√©cup√©rer la version:', error);
                document.getElementById('version-badge').textContent = `v${CONFIG.fallbackVersion}`;
                document.getElementById('android-version').textContent = 'T√©l√©charger APK';
            }
        }
        
        // ============================================
        // T√âL√âCHARGEMENT ANDROID
        // ============================================
        function downloadAndroid() {
            if (apkUrl) {
                // Ouvrir dans un nouvel onglet pour permettre le t√©l√©chargement
                window.open(apkUrl, '_blank');
            } else {
                alert('Le t√©l√©chargement n\'est pas encore disponible. Veuillez r√©essayer plus tard.');
            }
        }
        
        // ============================================
        // OUVERTURE DE L'APPLICATION
        // ============================================
        function openApp() {
            const deepLink = buildDeepLink();
            const loading = document.getElementById('loading');
            
            console.log('üîó Tentative d\'ouverture:', deepLink);
            
            // Afficher le loading
            loading.classList.add('show');
            
            // Cr√©er un iframe invisible pour essayer d'ouvrir l'app
            // sans quitter la page si l'app n'est pas install√©e
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = deepLink;
            document.body.appendChild(iframe);
            
            // Aussi essayer avec window.location comme fallback
            setTimeout(() => {
                window.location.href = deepLink;
            }, 100);
            
            // Si apr√®s 2.5 secondes l'app ne s'est pas ouverte
            setTimeout(() => {
                loading.classList.remove('show');
                document.body.removeChild(iframe);
                
                // Sur mobile, proposer le t√©l√©chargement
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    const shouldDownload = confirm(
                        'L\'application PayRent ne semble pas install√©e.\n\n' +
                        'Voulez-vous la t√©l√©charger maintenant ?'
                    );
                    
                    if (shouldDownload) {
                        if (/Android/i.test(navigator.userAgent)) {
                            downloadAndroid();
                        } else {
                            alert('L\'application iOS sera bient√¥t disponible sur l\'App Store.');
                        }
                    }
                }
            }, 2500);
        }
        
        // ============================================
        // TENTATIVE D'OUVERTURE AUTOMATIQUE
        // ============================================
        function tryAutoOpen() {
            // Seulement si on a un token et qu'on est sur mobile
            if (token && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // Attendre un peu que la page soit charg√©e
                setTimeout(() => {
                    openApp();
                }, 1000);
            }
        }
        
        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üè† PayRent - Page de redirection');
            console.log('üìã Token:', token || 'Aucun');
            console.log('üéØ Action:', action);
            
            // Mettre √† jour l'UI
            updateUI();
            
            // R√©cup√©rer la version
            await fetchVersion();
            
            // Tenter l'ouverture automatique sur mobile
            tryAutoOpen();
        });
    </script>
</body>
</html>
